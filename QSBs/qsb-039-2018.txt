

             ---===[ Qubes Security Bulletin #39 ]===---

                           April 20, 2018


         GUI issue allowing a window to have white borders

Summary
========

Christoffer Kugg Jerkeby discovered a situation in which Qubes GUI
virtualization could allow a VM to produce a window with borders that
are white instead of the color of the VM's label. (In Qubes, border
colors are used as front-line indicators of trust.) However, a VM cannot
use this vulnerability to draw borders with a non-white color other than
the correct one.  A very similar bug was fixed as part of QSB #34 [1],
but the fix missed this one case, as described below.

Technical details
==================

In QSB #34, we reported a similar bug involving the Qubes GUI daemon.
Whenever a VM displays a borderless window in Qubes, the Qubes GUI
daemon is responsible for drawing a colored border around it. In
particular, whenever a window content update is sent for the border area
of a bordless window, the GUI daemon draws a 2px border in that
location. The bug reported in QSB #34 occurred when a VM showed a
borderless splash screen window with a custom shape. While custom window
shapes are not supported in Qubes OS, VMs do not know this.  The VM
still thought the custom-shaped window was there, so it never sent
window content updates outside of the custom shape. Hence, it never sent
window content updates for the border areas of custom-shaped windows.
Since there were no window content updates for the border areas, nothing
triggered the GUI daemon to draw borders in those locations. As a
result, custom-shaped splash screen windows had no borders at all.

While the patch for QSB #34 fixed the case just described, it failed to
fix the case in which no window image is sent at all before mapping the
window. In this latter case, the argument sanitization section of the
do_shm_update function is skipped, resulting in arguments being ignored.
This, in turn, results in the window having borders that are white
instead of the color of the VM's label.

Patching
=========

The specific packages that resolve the problems discussed in this
bulletin are as follows:

  For Qubes 3.2:
  - qubes-gui-dom0, version 3.2.13

  For Qubes 4.0:
  - qubes-gui-dom0, version 4.0.8

The packages are to be installed in dom0 via the Qubes VM Manager or via
the qubes-dom0-update command as follows:

  For updates from the stable repository (not immediately available):
  $ sudo qubes-dom0-update

  For updates from the security-testing repository:
  $ sudo qubes-dom0-update --enablerepo=qubes-dom0-security-testing

A restart of all GUI daemons will be required afterwards, which can be
achieved by logging out and in.

These packages will migrate from the security-testing repository to the
current (stable) repository over the next two weeks after being tested
by the community.

Credits
========

The issue was discovered by Christoffer Kugg Jerkeby.

References
===========

[1] https://github.com/QubesOS/qubes-secpack/blob/master/QSBs/qsb-034-2017.txt

--
The Qubes Security Team
https://www.qubes-os.org/security/
